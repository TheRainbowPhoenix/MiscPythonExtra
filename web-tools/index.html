<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fxconv Web Tool</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .form-group { margin-bottom: 10px; }
        label { display: inline-block; width: 150px; vertical-align: top; }
        textarea { width: 100%; height: 300px; font-family: monospace; }
        #canvas { border: 1px solid #ccc; max-width: 100%; margin-top: 10px; }

        .mode-selector { margin-bottom: 20px; }
        .mode-btn { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        .mode-btn.active { background-color: #007bff; color: white; border-color: #0056b3; }

        .hidden { display: none; }

        .section { border: 1px solid #eee; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        h2 { margin-top: 0; }
    </style>
</head>
<body>
    <h1>fxconv Web Tool</h1>

    <div class="mode-selector">
        <button id="btnModeConvert" class="mode-btn active" onclick="setMode('convert')">Convert Image</button>
        <button id="btnModeGenerate" class="mode-btn" onclick="setMode('generate')">Generate from Font</button>
    </div>

    <!-- Common Parameters -->
    <div class="section">
        <h2>Common Parameters</h2>
        <div class="form-group">
            <label for="name">Variable Name:</label>
            <input type="text" id="name" value="my_font">
        </div>

        <div class="form-group">
            <label for="charset">Charset:</label>
            <select id="charset">
                <option value="print">print (ASCII 0x20-0x7E)</option>
                <option value="numeric">numeric (0-9)</option>
                <option value="upper">upper (A-Z)</option>
                <option value="alpha">alpha (A-Z, a-z)</option>
                <option value="alnum">alnum (A-Z, a-z, 0-9)</option>
                <option value="ascii">ascii (0x00-0x7F)</option>
                <option value="256chars">256chars (0x00-0xFF)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="proportional">Proportional:</label>
            <input type="checkbox" id="proportional" checked>
        </div>

        <div class="form-group">
            <label for="charSpacing">Char Spacing:</label>
            <input type="number" id="charSpacing" value="1">
        </div>

        <div class="form-group">
            <label for="lineDistance">Line Distance:</label>
            <input type="number" id="lineDistance" value="" placeholder="Default: height + 1">
        </div>
    </div>

    <!-- Convert Mode UI -->
    <div id="sectionConvert" class="section">
        <h2>Image Input</h2>
        <div class="form-group">
            <label for="inputFile">Font Image:</label>
            <input type="file" id="inputFile" accept="image/png, image/jpeg">
        </div>

        <div class="form-group">
            <label for="gridWidth">Grid Width:</label>
            <input type="number" id="gridWidth" value="8">
        </div>

        <div class="form-group">
            <label for="gridHeight">Grid Height:</label>
            <input type="number" id="gridHeight" value="8">
        </div>

        <div class="form-group">
            <label for="gridPadding">Grid Padding:</label>
            <input type="number" id="gridPadding" value="0">
        </div>

        <div class="form-group">
            <label for="gridBorder">Grid Border:</label>
            <input type="number" id="gridBorder" value="0">
        </div>

        <button onclick="convertFromImage()">Convert Image</button>
    </div>

    <!-- Generate Mode UI -->
    <div id="sectionGenerate" class="section hidden">
        <h2>Font Input</h2>
        <div class="form-group">
            <label for="fontFile">Font File (.ttf/.otf):</label>
            <input type="file" id="fontFile" accept=".ttf,.otf,.woff">
        </div>

        <div class="form-group">
            <label for="fontSize">Font Size (px):</label>
            <input type="number" id="fontSize" value="16">
        </div>

        <div class="form-group">
            <label for="genPadding">Inner Padding:</label>
            <input type="number" id="genPadding" value="0">
        </div>

        <button onclick="generateAndConvert()">Generate & Convert</button>
    </div>

    <h3>Output</h3>
    <div class="form-group">
        <button onclick="downloadPy()">Download .py</button>
        <button onclick="downloadPng()">Download .png</button>
    </div>

    <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
            <h4>Python Code</h4>
            <textarea id="output" readonly></textarea>
        </div>
        <div style="flex: 1;">
            <h4>Preview</h4>
            <div style="overflow: auto; border: 1px solid #ccc; max-height: 300px;">
                <canvas id="canvas"></canvas>
            </div>
            <div id="previewInfo" style="margin-top: 5px; font-size: 0.9em; color: #666;"></div>
        </div>
    </div>

    <script src="fxconv_core.js"></script>
    <script src="font_generator.js"></script>
    <script>
        let currentMode = 'convert';
        let generatedGridParams = null; // Store grid params when generating

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btnModeConvert').className = mode === 'convert' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('btnModeGenerate').className = mode === 'generate' ? 'mode-btn active' : 'mode-btn';

            document.getElementById('sectionConvert').className = mode === 'convert' ? 'section' : 'section hidden';
            document.getElementById('sectionGenerate').className = mode === 'generate' ? 'section' : 'section hidden';
        }

        // --- Common Helpers ---

        function getCommonParams() {
            const params = {
                name: document.getElementById('name').value,
                charset: document.getElementById('charset').value,
                proportional: document.getElementById('proportional').checked,
                'char-spacing': document.getElementById('charSpacing').value,
            };
            const lineDist = document.getElementById('lineDistance').value;
            if (lineDist) params['line-distance'] = lineDist;
            return params;
        }

        function displayResult(code, canvasSource) {
            document.getElementById('output').value = code;

            const destCanvas = document.getElementById('canvas');
            // If canvasSource is already a canvas, copy it
            if (canvasSource instanceof HTMLCanvasElement) {
                destCanvas.width = canvasSource.width;
                destCanvas.height = canvasSource.height;
                const ctx = destCanvas.getContext('2d');
                ctx.drawImage(canvasSource, 0, 0);
            }
        }

        function updatePreviewInfo(width, height, gridParams) {
             document.getElementById('previewInfo').innerText =
                `Image Size: ${width}x${height} | Grid: ${gridParams.width}x${gridParams.height}`;
        }

        // --- Convert Mode ---

        function convertFromImage() {
            const fileInput = document.getElementById('inputFile');
            if (!fileInput.files || !fileInput.files[0]) {
                alert("Please select an image file.");
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    processConvertImage(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function processConvertImage(img) {
            const canvas = document.createElement('canvas'); // Temp canvas
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            const imageWrapper = createWrapper(data, canvas.width, canvas.height);

            const params = getCommonParams();
            params.grid = {
                width: document.getElementById('gridWidth').value,
                height: document.getElementById('gridHeight').value,
                padding: document.getElementById('gridPadding').value,
                border: document.getElementById('gridBorder').value,
            };

            try {
                const output = window.fxconv.convert_topti(imageWrapper, params);
                displayResult(output, canvas);
                updatePreviewInfo(canvas.width, canvas.height, params.grid);
            } catch (err) {
                alert("Error: " + err.message);
                console.error(err);
            }
        }

        // --- Generate Mode ---

        async function generateAndConvert() {
            const fontInput = document.getElementById('fontFile');
            if (!fontInput.files || !fontInput.files[0]) {
                alert("Please select a font file.");
                return;
            }

            const fontSize = parseInt(document.getElementById('fontSize').value);
            const padding = parseInt(document.getElementById('genPadding').value);
            const charset = document.getElementById('charset').value;

            try {
                const result = await window.generateFontAtlas(fontInput.files[0], fontSize, charset, padding);

                const canvas = result.canvas;
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                const imageWrapper = createWrapper(data, canvas.width, canvas.height);

                const params = getCommonParams();
                params.grid = result.grid; // Use calculated grid params

                const output = window.fxconv.convert_topti(imageWrapper, params);

                displayResult(output, canvas);
                updatePreviewInfo(canvas.width, canvas.height, params.grid);

            } catch (err) {
                alert("Generation Error: " + err.message);
                console.error(err);
            }
        }

        // --- Utilities ---

        function createWrapper(data, width, height) {
            return {
                width: width,
                height: height,
                isBlack: (x, y) => {
                    if (x < 0 || x >= width || y < 0 || y >= height) return false;
                    const idx = (width * y + x) * 4;
                    const r = data[idx];
                    const g = data[idx+1];
                    const b = data[idx+2];
                    const a = data[idx+3];

                    if (a < 128) return false;
                    const avg = (r + g + b) / 3;
                    return avg < 128; // Black threshold for generated content
                },
                isWhite: (x, y) => {
                    if (x < 0 || x >= width || y < 0 || y >= height) return true;
                    const idx = (width * y + x) * 4;
                    const r = data[idx];
                    const g = data[idx+1];
                    const b = data[idx+2];
                    const a = data[idx+3];

                    if (a < 128) return false;
                    const avg = (r + g + b) / 3;
                    return avg >= 128; // White threshold
                }
            };
        }

        function downloadPy() {
            const content = document.getElementById('output').value;
            if (!content) return;
            const name = document.getElementById('name').value || "font";
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name + ".py";
            a.click();
        }

        function downloadPng() {
            const canvas = document.getElementById('canvas');
            if (canvas.width === 0) return;
            const name = document.getElementById('name').value || "font";
            const a = document.createElement('a');
            a.href = canvas.toDataURL('image/png');
            a.download = name + ".png";
            a.click();
        }
    </script>
</body>
</html>
